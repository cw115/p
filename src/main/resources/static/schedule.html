<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>íšŒì˜ ì¼ì • & ì‹œê°„ ê´€ë¦¬</title>
<style>
:root{
    --gap:10px;
    --cell:44px;
    --radius:10px;
    --line:#e9edf2;
    --text:#1f2937;
    --sub:#6b7280;
    --blue:#2563eb;
    --blue-weak:#e8f0ff;
    --red:#ef4444;
}
*{box-sizing:border-box;}
body{margin:0;padding:24px;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial,sans-serif;color:var(--text);background:#f8fafc;}
h1{font-size:20px;margin:0 0 12px;}
h2{font-size:16px;margin:18px 0 8px;}
.card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:16px;box-shadow:0 4px 16px rgba(0,0,0,.03);}
.row{display:flex;gap:12px;flex-wrap:wrap;align-items:end;}
.field{display:grid;gap:6px;}
label{font-size:12px;color:var(--sub);}
input, select, button, textarea{height:40px;padding:0 12px;border-radius:10px;border:1px solid var(--line);background:#fff;color:var(--text);outline:none;}
input:focus, select:focus, textarea:focus{border-color:#c7d2fe;box-shadow:0 0 0 3px #eef2ff;}
button{cursor:pointer;font-weight:600;border:1px solid #dbe3f1;background:#f8fafc;}
button.primary{background:var(--blue);color:#fff;border-color:var(--blue);}
button.ghost{background:#fff;}
.muted{color:var(--sub);font-size:12px;}
.hr{height:1px;background:var(--line);margin:16px 0;}
.two{display:grid;gap:16px;grid-template-columns:1fr 1fr;}
@media(max-width:1024px){.two{grid-template-columns:1fr;}}
.legend{display:grid;grid-template-columns:repeat(24, var(--cell));gap:6px;margin:4px 0 10px;font-size:11px;color:var(--sub);}
.grid{display:grid;grid-template-columns:repeat(24, var(--cell));gap:6px;padding:12px;border:1px solid var(--line);border-radius:12px;background:#fff;overflow-x:auto;}
.slot{width:var(--cell);height:var(--cell);border-radius:8px;border:1px solid var(--line);display:flex;align-items:center;justify-content:center;font-size:11px;color:#6b7280;cursor:pointer;transition:transform .06s ease, background .1s ease, border-color .1s ease, color .1s ease;user-select:none;}
.slot:hover{transform:translateY(-1px);border-color:#cbd5e1;}
.slot.active{background:var(--blue-weak);border-color:#bcd1ff;color:#1d4ed8;font-weight:700;box-shadow: inset 0 0 0 2px #cfe0ff;}
.toast{margin-top:10px;padding:10px 12px;border-radius:10px;font-size:14px;display:none;border:1px solid var(--line);background:#f9fafb;}
.toast.ok{border-color:#d1fae5;background:#ecfdf5;color:#065f46;}
.toast.err{border-color:#fee2e2;background:#fef2f2;color:#991b1b;}
.result-item{border:1px solid var(--line);border-radius:10px;padding:12px;display:flex;gap:10px;align-items:center;background:#fff;}
.chip{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid var(--line);color:#374151;background:#f9fafb;}
.ranges{font-variant-numeric:tabular-nums;}
.modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,0.4);padding-top:20px;}
.modal.show{display:block;}
.modal-content{background-color:#fefefe;margin:5% auto;padding:24px;border-radius:14px;border:1px solid var(--line);width:95%;max-width:1100px;box-shadow:0 8px 32px rgba(0,0,0,0.2);}
.schedule-item { cursor: pointer; padding: 10px; margin-top: 8px; border: 1px solid var(--line); border-radius: 8px; transition: background .1s ease; }
.schedule-item:hover { background: #f0f4f8; }
.schedule-item.selected { border-color: var(--blue); background: var(--blue-weak); font-weight: 600; }
</style>
</head>
<body>

<h1>ğŸ—“ï¸ í”„ë¡œì íŠ¸ íšŒì˜ ì¼ì • ë° ê°€ëŠ¥ ì‹œê°„ ê´€ë¦¬</h1>

<div class="card">
    <p>í”„ë¡œì íŠ¸: <span id="projectTitleDisplay">í”„ë¡œì íŠ¸ ì„ íƒë¨</span></p>
    <button id="openModalBtn" class="primary" style="margin-top:10px;">ğŸ¤ ì°¸ì—¬ì íšŒì˜ ê°€ëŠ¥ ì‹œê°„ ê´€ë¦¬</button>
</div>

<div class="two">
    <div class="card">
        <h2>íšŒì˜ ì¼ì • ë“±ë¡ / ì¡°íšŒ</h2>
        <div class="row">
            <input id="scheduleTitle" type="text" placeholder="ì¼ì • ì œëª©" style="flex:1;">
            <input id="scheduleStartTime" type="datetime-local">
            <input id="scheduleEndTime" type="datetime-local">
            <button id="addScheduleBtn" class="primary">ë“±ë¡</button>
        </div>
        <div id="scheduleToast" class="toast"></div>
        <div id="scheduleList" style="max-height:400px; overflow-y:auto;"></div>
    </div>
    <div class="card">
        <h2>íšŒì˜ ê²°ê³¼ ê´€ë¦¬</h2>
        <div id="selectedScheduleTitle" style="font-weight:600;margin-bottom:10px;">ì¼ì •ì„ ì„ íƒí•˜ì„¸ìš”.</div>
        <div id="resultInputSection" style="display:none;">
            <textarea id="resultContent" placeholder="íšŒì˜ ê²°ê³¼ ì…ë ¥" style="width:100%;height:100px;padding:10px;border-radius:10px;"></textarea>
            <button id="addResultBtn" class="primary" style="margin-top:10px;">ê²°ê³¼ ì €ì¥</button>
            <div id="addResultToast" class="toast"></div>
        </div>
        <div id="resultList" style="margin-top:15px;"></div>
    </div>
</div>

<div id="timeModal" class="modal">
    <div class="modal-content">
        <h1>íšŒì˜ ê°€ëŠ¥ ì‹œê°„ ê´€ë¦¬</h1>
        <section class="card">
            <h2>1) ë‚´ ê°€ëŠ¥ ì‹œê°„ ì…ë ¥</h2>
            <div class="row">
                <div class="field"><label>ì‚¬ìš©ì ë‹‰ë„¤ì„</label><input id="slotUserNickname" type="text" placeholder="DBì— ì¡´ì¬í•˜ëŠ” ë‹‰ë„¤ì„ ì…ë ¥" value="testuser1"></div>
                <div class="field"><label>ìš”ì¼</label>
                    <select id="slotDayOfWeek">
                        <option value="1">ì›”</option><option value="2">í™”</option><option value="3">ìˆ˜</option>
                        <option value="4">ëª©</option><option value="5">ê¸ˆ</option><option value="6">í† </option>
                        <option value="7">ì¼</option>
                    </select>
                </div>
                <div class="field"><label>&nbsp;</label><button id="loadSlotsBtn" class="ghost">ë¶ˆëŸ¬ì˜¤ê¸°</button></div>
                <div class="field"><label>&nbsp;</label><button id="clearSlotsBtn" class="ghost">ì´ˆê¸°í™”</button></div>
                <div class="field"><label>&nbsp;</label><button id="saveSlotsBtn" class="primary">ì €ì¥</button></div>
            </div>
            <div class="legend" id="legendAM"></div>
            <div id="gridAM" class="grid"></div>
            <div class="legend" id="legendPM"></div>
            <div id="gridPM" class="grid"></div>
            <div id="slotToast" class="toast"></div>
        </section>
        <section class="card">
            <h2>2) ì°¸ì—¬ì ê³µí†µ ê°€ëŠ¥ ì‹œê°„</h2>
            <div class="row">
                <div class="field" style="flex:1;"><label>ì°¸ì—¬ì ë‹‰ë„¤ì„ (ì‰¼í‘œ êµ¬ë¶„)</label><input id="intersectUserNicknames" type="text" placeholder="user1,user2,user3"></div>
                <div class="field"><label>&nbsp;</label><button id="findIntersectBtn" class="primary">êµì§‘í•© ë„ì¶œ</button></div>
            </div>
            <div id="intersectResult" style="margin-top:15px;"></div>
        </section>
        <button id="closeModalBtn" class="ghost" style="margin-top:10px;">ë‹«ê¸°</button>
    </div>
</div>

<script>
// --- í”„ë¡œì íŠ¸ ID/ì œëª© ì²˜ë¦¬
const urlParams = new URLSearchParams(window.location.search);
const currentProjectId = Number(urlParams.get('projectId'));
const currentProjectTitle = urlParams.get('projectTitle');
document.getElementById('projectTitleDisplay').textContent = currentProjectTitle || 'í”„ë¡œì íŠ¸ ì—†ìŒ';
if(!currentProjectId || isNaN(currentProjectId)){ 
    // alert('í”„ë¡œì íŠ¸ IDê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. URLì— ?projectId=ìˆ«ì í˜•ì‹ìœ¼ë¡œ IDë¥¼ ì „ë‹¬í•´ ì£¼ì„¸ìš”.'); 
}

// --- ì „ì—­ ìƒíƒœ ë° ìœ í‹¸ë¦¬í‹°
let selectedScheduleId = null;
const scheduleListElement = document.getElementById('scheduleList');
const resultListElement = document.getElementById('resultList');
const selectedScheduleTitleElement = document.getElementById('selectedScheduleTitle');
const resultInputSectionElement = document.getElementById('resultInputSection');

function showToast(elementId, message, isSuccess = true) {
    const toast = document.getElementById(elementId);
    toast.textContent = message;
    toast.classList.remove('ok', 'err');
    toast.classList.add(isSuccess ? 'ok' : 'err');
    toast.style.display = 'block';
    setTimeout(() => toast.style.display = 'none', 5000); 
}

// --- API í†µì‹  í•¨ìˆ˜
async function api(endpoint, method='GET', body=null){
    const token = localStorage.getItem('userToken'); 
    const res = await fetch(endpoint, {
        method, 
        headers:{'Content-Type':'application/json','Authorization': token?`Bearer ${token}`:''},
        body: body?JSON.stringify(body):null
    });
    
    if(res.status === 204 || res.status === 201) return null; 
    
    if(!res.ok){ 
        const contentType = res.headers.get("content-type");
        let errorText = `ì„œë²„ ì˜¤ë¥˜ (ìƒíƒœ ì½”ë“œ: ${res.status})`;
        try {
            const errorBody = contentType && contentType.includes("application/json") ? await res.json() : await res.text();
            errorText = (typeof errorBody === 'object' && errorBody.message) ? errorBody.message : (typeof errorBody === 'string' && errorBody.length > 0) ? errorBody : errorText;
        } catch (e) {
            errorText = `ì„œë²„ ì˜¤ë¥˜ (ìƒíƒœ ì½”ë“œ: ${res.status})`;
        }
        // DB ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ ë” ì‚¬ìš©ì ì¹œí™”ì ìœ¼ë¡œ ë³€ê²½
        if(errorText.includes("Cannot add or update a child row")) {
             errorText = "DB ì™¸ë˜ í‚¤ ì œì•½ ì¡°ê±´ ìœ„ë°˜ ì˜¤ë¥˜ (ì…ë ¥í•œ ì •ë³´ê°€ DBì— ì¡´ì¬í•˜ì§€ ì•ŠìŒ)";
        }
        throw new Error(errorText); 
    }
    return await res.json();
}

// --- ì‹œê°„ ìŠ¬ë¡¯ ê·¸ë¦¬ë“œ (AM/PM)
const selectedSlots = new Set();
function formatTime(h,m){ return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:00`; } 
function getHourMinute(timeStr) { return [parseInt(timeStr.substring(0, 2)), parseInt(timeStr.substring(3, 5))]; }
function createGrid(containerId,startHour,endHour){
    const container = document.getElementById(containerId); container.innerHTML='';
    for(let h=startHour;h<endHour;h++){
        for(let m=0;m<60;m+=30){
            const time = formatTime(h,m);
            const btn = document.createElement('button');
            btn.className='slot'; btn.dataset.time=time; btn.textContent=m===0?time.substring(0,2):time.substring(3,5);
            btn.onclick=()=>{ 
                if(btn.classList.contains('active')){
                    selectedSlots.delete(time); btn.classList.remove('active'); 
                } else {
                    selectedSlots.add(time); btn.classList.add('active'); 
                } 
            };
            container.appendChild(btn);
        }
    }
}
createGrid('gridAM',0,12);
createGrid('gridPM',12,24);

// --- 1. íšŒì˜ ì¼ì • ê´€ë¦¬ (ë“±ë¡/ì¡°íšŒ) (ìœ ì§€) ---

function renderSchedules(schedules) {
    scheduleListElement.innerHTML = '';
    schedules.forEach(schedule => {
        const item = document.createElement('div');
        item.className = 'schedule-item';
        const start = new Date(schedule.startTime).toLocaleString('ko-KR', { dateStyle: 'short', timeStyle: 'short' });
        const end = new Date(schedule.endTime).toLocaleString('ko-KR', { timeStyle: 'short' });
        
        item.innerHTML = `
            <div>${schedule.title}</div>
            <div class="muted">${start} - ${end}</div>
        `;
        item.dataset.scheduleId = schedule.scheduleId;
        item.onclick = () => selectSchedule(schedule);
        scheduleListElement.appendChild(item);
    });
    if (schedules.length > 0 && !selectedScheduleId) {
        selectSchedule(schedules[0]);
    } else if (schedules.length > 0 && selectedScheduleId) {
        const selectedSchedule = schedules.find(s => s.scheduleId === selectedScheduleId);
        if (selectedSchedule) selectSchedule(selectedSchedule);
    }
}

async function loadSchedules() {
    if (!currentProjectId || isNaN(currentProjectId) || currentProjectId <= 0) return;
    try {
        const schedules = await api(`/api/schedules/project/${currentProjectId}`); 
        renderSchedules(schedules || []);
    } catch (e) {
        console.error('ì¼ì • ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', e);
    }
}

document.getElementById('addScheduleBtn').onclick = async () => {
    const title = document.getElementById('scheduleTitle').value;
    const startTime = document.getElementById('scheduleStartTime').value;
    const endTime = document.getElementById('scheduleEndTime').value;

    if (!title || !startTime || !endTime) {
        showToast('scheduleToast', 'ëª¨ë“  í•„ë“œë¥¼ ì±„ì›Œì£¼ì„¸ìš”.', false);
        return;
    }
    
    if (!currentProjectId || isNaN(currentProjectId) || currentProjectId <= 0) {
        showToast('scheduleToast', 'ìœ íš¨í•œ í”„ë¡œì íŠ¸ IDê°€ ì—†ìŠµë‹ˆë‹¤. URLì„ í™•ì¸í•´ ì£¼ì„¸ìš”.', false);
        return;
    }

    const scheduleRequest = {
        projectId: currentProjectId, 
        title: title,
        startTime: startTime + ':00', 
        endTime: endTime + ':00' 
    };

    try {
        await api('/api/schedules/add', 'POST', scheduleRequest); 
        loadSchedules();
        document.getElementById('scheduleTitle').value = '';
        document.getElementById('scheduleStartTime').value = '';
        document.getElementById('scheduleEndTime').value = '';
        showToast('scheduleToast', 'íšŒì˜ ì¼ì •ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.', true);
    } catch (e) {
        console.error('ì¼ì • ë“±ë¡ ì‹¤íŒ¨:', e);
        showToast('scheduleToast', 'ì¼ì • ë“±ë¡ ì‹¤íŒ¨: í”„ë¡œì íŠ¸ IDê°€ DBì— ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”. (' + e.message + ')', false);
    }
};

// --- 2. íšŒì˜ ê²°ê³¼ ê´€ë¦¬ (ìˆ˜ì •/ì‚­ì œ ê¸°ëŠ¥ ì¶”ê°€ë¨) ---

function renderResults(results) {
    resultListElement.innerHTML = '';
    if (!results || results.length === 0) {
        resultListElement.innerHTML = '<div class="muted">ì €ì¥ëœ íšŒì˜ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
    }

    results.forEach(result => {
        const item = document.createElement('div');
        item.className = 'result-item';
        item.dataset.resultId = result.resultId; // ê²°ê³¼ IDë¥¼ ë°ì´í„°ì…‹ì— ì €ì¥

        item.innerHTML = `
            <div style="flex:1;">
                <div class="result-content-display" style="white-space: pre-wrap;">${result.content}</div>
                <textarea class="edit-result-content" style="width:100%;height:100px;padding:10px;border-radius:10px;display:none;">${result.content}</textarea>
            </div>
            <div class="chip">${new Date(result.createdAt).toLocaleDateString('ko-KR')}</div>
            <div style="display:flex; gap: 8px;">
                <button class="edit-btn ghost" data-id="${result.resultId}" style="width:50px; height: 32px;">ìˆ˜ì •</button>
                <button class="delete-btn ghost" data-id="${result.resultId}" style="width:50px; height: 32px;">ì‚­ì œ</button>
                <button class="save-btn primary" data-id="${result.resultId}" style="display:none; width:50px; height: 32px;">ì €ì¥</button>
                <button class="cancel-btn ghost" data-id="${result.resultId}" style="display:none; width:50px; height: 32px;">ì·¨ì†Œ</button>
            </div>
        `;
        resultListElement.appendChild(item);
    });
    
    attachResultEventListeners(); // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²°
}

// ë™ì ìœ¼ë¡œ ìƒì„±ëœ ê²°ê³¼ í•­ëª©ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì—°ê²°í•˜ëŠ” í•¨ìˆ˜
function attachResultEventListeners() {
    resultListElement.querySelectorAll('.edit-btn').forEach(btn => {
        btn.onclick = (e) => toggleEditMode(e.target.dataset.id, true);
    });

    resultListElement.querySelectorAll('.delete-btn').forEach(btn => {
        btn.onclick = (e) => handleDelete(e.target.dataset.id);
    });
    
    resultListElement.querySelectorAll('.save-btn').forEach(btn => {
        btn.onclick = (e) => handleUpdate(e.target.dataset.id);
    });

    resultListElement.querySelectorAll('.cancel-btn').forEach(btn => {
        btn.onclick = (e) => toggleEditMode(e.target.dataset.id, false);
    });
}

// í¸ì§‘ ëª¨ë“œ/ë³´ê¸° ëª¨ë“œ ì „í™˜ ë¡œì§
function toggleEditMode(resultId, isEditing) {
    const item = resultListElement.querySelector(`[data-result-id="${resultId}"]`);
    if (!item) return;

    const display = item.querySelector('.result-content-display');
    const textarea = item.querySelector('.edit-result-content');
    const editBtn = item.querySelector('.edit-btn');
    const deleteBtn = item.querySelector('.delete-btn');
    const saveBtn = item.querySelector('.save-btn');
    const cancelBtn = item.querySelector('.cancel-btn');

    if (isEditing) {
        textarea.value = display.textContent.trim(); // í˜„ì¬ ë‚´ìš©ì„ textareaë¡œ ë³µì‚¬
        display.style.display = 'none';
        textarea.style.display = 'block';
        editBtn.style.display = 'none';
        deleteBtn.style.display = 'none';
        saveBtn.style.display = 'block';
        cancelBtn.style.display = 'block';
        textarea.focus();
    } else {
        // ì·¨ì†Œí•˜ê±°ë‚˜ ì €ì¥ í›„ ë³´ê¸° ëª¨ë“œë¡œ ëŒì•„ê°ˆ ë•Œ
        display.style.display = 'block';
        textarea.style.display = 'none';
        editBtn.style.display = 'block';
        deleteBtn.style.display = 'block';
        saveBtn.style.display = 'none';
        cancelBtn.style.display = 'none';
    }
}

// ê²°ê³¼ ìˆ˜ì • API í˜¸ì¶œ
async function handleUpdate(resultId) {
    const item = resultListElement.querySelector(`[data-result-id="${resultId}"]`);
    const newContent = item.querySelector('.edit-result-content').value.trim();

    if (!newContent) {
        showToast('addResultToast', 'ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', false);
        return;
    }

    try {
        // ë°±ì—”ë“œì—ì„œ JSON ë°”ë”” { "content": "ìƒˆ ë‚´ìš©" }ì„ ë°›ëŠ”ë‹¤ê³  ê°€ì •
        const updateBody = { content: newContent }; 
        await api(`/api/results/${resultId}`, 'PUT', updateBody); 
        
        // ì„±ê³µ í›„ UI ì—…ë°ì´íŠ¸ ë° ê²°ê³¼ ëª©ë¡ ì¬ë¡œë“œ
        toggleEditMode(resultId, false);
        loadResults(selectedScheduleId);
        showToast('addResultToast', 'íšŒì˜ ê²°ê³¼ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.', true);
    } catch (e) {
        console.error('ê²°ê³¼ ìˆ˜ì • ì‹¤íŒ¨:', e);
        showToast('addResultToast', 'ê²°ê³¼ ìˆ˜ì • ì‹¤íŒ¨: ' + (e.message || 'ì„œë²„ ì˜¤ë¥˜'), false);
    }
}

// ê²°ê³¼ ì‚­ì œ API í˜¸ì¶œ
async function handleDelete(resultId) {
    if (!confirm('ì •ë§ë¡œ ì´ íšŒì˜ ê²°ê³¼ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
    }

    try {
        // DELETE API í˜¸ì¶œ (204 No Contentë¥¼ ê¸°ëŒ€)
        await api(`/api/results/${resultId}`, 'DELETE');
        
        // ì„±ê³µ í›„ ê²°ê³¼ ëª©ë¡ ì¬ë¡œë“œ
        loadResults(selectedScheduleId);
        showToast('addResultToast', 'íšŒì˜ ê²°ê³¼ê°€ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', true);
    } catch (e) {
        console.error('ê²°ê³¼ ì‚­ì œ ì‹¤íŒ¨:', e);
        showToast('addResultToast', 'ê²°ê³¼ ì‚­ì œ ì‹¤íŒ¨: ' + (e.message || 'ì„œë²„ ì˜¤ë¥˜'), false);
    }
}

async function loadResults(scheduleId) {
    try {
        const results = await api(`/api/results/${scheduleId}`); 
        renderResults(results);
    } catch (e) {
        console.error('íšŒì˜ ê²°ê³¼ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', e);
        renderResults(null);
    }
}

function selectSchedule(schedule) {
    const scheduleItems = document.querySelectorAll('.schedule-item');
    scheduleItems.forEach(item => item.classList.remove('selected'));
    
    const selectedItem = document.querySelector(`[data-schedule-id="${schedule.scheduleId}"]`);
    if (selectedItem) selectedItem.classList.add('selected');

    selectedScheduleId = schedule.scheduleId;
    selectedScheduleTitleElement.textContent = `[${schedule.scheduleId}] ${schedule.title}`;
    resultInputSectionElement.style.display = 'block';
    
    loadResults(schedule.scheduleId);
}

document.getElementById('addResultBtn').onclick = async () => {
    const content = document.getElementById('resultContent').value;
    if (!selectedScheduleId || !content) {
        showToast('addResultToast', 'ì¼ì •ì„ ì„ íƒí•˜ê±°ë‚˜ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.', false);
        return;
    }

    const resultRequest = {
        scheduleId: selectedScheduleId,
        content: content
    };

    try {
        await api('/api/results', 'POST', resultRequest); 
        showToast('addResultToast', 'íšŒì˜ ê²°ê³¼ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', true);
        document.getElementById('resultContent').value = '';
        loadResults(selectedScheduleId);
    } catch (e) {
        console.error('ê²°ê³¼ ì €ì¥ ì‹¤íŒ¨:', e);
        showToast('addResultToast', 'ê²°ê³¼ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (e.message || 'ì„œë²„ ì˜¤ë¥˜'), false);
    }
};

// --- 3. íšŒì˜ ê°€ëŠ¥ ì‹œê°„ ê´€ë¦¬ (ë‹‰ë„¤ì„ ê¸°ë°˜ìœ¼ë¡œ ìˆ˜ì •ë¨) ---

function resetTimeSlotUI() {
    selectedSlots.clear();
    document.querySelectorAll('.slot').forEach(btn => btn.classList.remove('active'));
}

function activateTimeSlotUI(slots) {
    resetTimeSlotUI();
    slots.forEach(slot => {
        const [startH, startM] = getHourMinute(slot.startTime);
        const [endH, endM] = getHourMinute(slot.endTime);

        let currentH = startH;
        let currentM = startM;
        while (currentH * 60 + currentM < endH * 60 + endM) {
            const timeStr = formatTime(currentH, currentM);
            const btn = document.querySelector(`.slot[data-time="${timeStr}"]`);
            if (btn) {
                selectedSlots.add(timeStr);
                btn.classList.add('active');
            }
            currentM += 30;
            if (currentM >= 60) {
                currentM -= 60;
                currentH += 1;
            }
            if (currentH >= 24) break; 
        }
    });
}

document.getElementById('loadSlotsBtn').onclick = async () => {
    const nickname = document.getElementById('slotUserNickname').value.trim();
    const dayOfWeek = document.getElementById('slotDayOfWeek').value;

    if (!nickname) {
        showToast('slotToast', 'ì‚¬ìš©ì ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”.', false);
        return;
    }

    try {
        const allSlots = await api(`/api/time-slots?nickname=${nickname}`); 
        const filteredSlots = allSlots.filter(slot => slot.dayOfWeek === Number(dayOfWeek));
        
        activateTimeSlotUI(filteredSlots);
        showToast('slotToast', `${nickname} ë‹˜ì˜ ${dayOfWeek}ìš”ì¼ ê°€ëŠ¥ ì‹œê°„ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`, true);
    } catch (e) {
        console.error('ìŠ¬ë¡¯ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', e);
        showToast('slotToast', 'ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + (e.message || 'ì„œë²„ ì˜¤ë¥˜'), false);
    }
};

document.getElementById('saveSlotsBtn').onclick = async () => {
    const nickname = document.getElementById('slotUserNickname').value.trim();
    const dayOfWeek = Number(document.getElementById('slotDayOfWeek').value);
    
    if (!nickname) {
        showToast('slotToast', 'ìœ íš¨í•œ ì‚¬ìš©ì ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”.', false);
        return;
    }

    if (selectedSlots.size === 0) {
        showToast('slotToast', 'ì‹œê°„ ìŠ¬ë¡¯ì„ í•˜ë‚˜ ì´ìƒ ì„ íƒí•˜ì„¸ìš”.', false);
        return;
    }

    try {
        const sortedTimes = Array.from(selectedSlots).sort();
        const ranges = [];
        let currentRange = null;

        for (const time of sortedTimes) {
            const [h, m] = getHourMinute(time);
            
            if (currentRange) {
                const [lastH, lastM] = getHourMinute(currentRange.endTime);
                
                let nextH = lastH, nextM = lastM + 30;
                if (nextM >= 60) { nextM -= 60; nextH += 1; }

                if (formatTime(nextH, nextM) === time) {
                    let newEndH = h, newEndM = m + 30;
                    if (newEndM >= 60) { newEndM -= 60; newEndH += 1; }
                    currentRange.endTime = formatTime(newEndH, newEndM);
                    continue;
                } else {
                    ranges.push(currentRange);
                    currentRange = null;
                }
            }
            
            if (!currentRange) {
                let endH = h, endM = m + 30;
                if (endM >= 60) { endM -= 60; endH += 1; }
                currentRange = {
                    startTime: time,
                    endTime: formatTime(endH, endM)
                };
            }
        }
        if (currentRange) ranges.push(currentRange);

        for (const range of ranges) {
            const slotRequest = {
                nickname: nickname,
                dayOfWeek: dayOfWeek,
                startTime: range.startTime,
                endTime: range.endTime
            };
            await api('/api/time-slots', 'POST', slotRequest); 
        }
        
        showToast('slotToast', `${ranges.length}ê°œì˜ ì‹œê°„ëŒ€ê°€ ${nickname} ë‹˜ì—ê²Œ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`, true);
    } catch (e) {
        console.error('ìŠ¬ë¡¯ ì €ì¥ ì‹¤íŒ¨:', e);
        showToast('slotToast', 'ì €ì¥ ì‹¤íŒ¨: ' + (e.message || 'ì„œë²„ ì˜¤ë¥˜'), false);
    }
};

document.getElementById('clearSlotsBtn').onclick = () => {
    resetTimeSlotUI();
    showToast('slotToast', 'ì„ íƒëœ ì‹œê°„ì„ ì´ˆê¸°í™”í–ˆìŠµë‹ˆë‹¤. (DB ë‚´ìš©ì€ ë³€ê²½ë˜ì§€ ì•ŠìŒ)', true);
};

// --- 4. ì°¸ì—¬ì ê³µí†µ ê°€ëŠ¥ ì‹œê°„ (ë‹‰ë„¤ì„ ê¸°ë°˜ìœ¼ë¡œ ìˆ˜ì •ë¨) ---

async function getUserSlotsByDay(nickname, dayOfWeek) {
    try {
        const allSlots = await api(`/api/time-slots?nickname=${nickname}`);
        const filteredSlots = allSlots.filter(slot => slot.dayOfWeek === Number(dayOfWeek));
        
        const slotSet = new Set();
        filteredSlots.forEach(slot => {
            const [startH, startM] = getHourMinute(slot.startTime);
            const [endH, endM] = getHourMinute(slot.endTime);

            let currentH = startH;
            let currentM = startM;
            while (currentH * 60 + currentM < endH * 60 + endM) {
                slotSet.add(formatTime(currentH, currentM).substring(0, 5)); 
                
                currentM += 30;
                if (currentM >= 60) {
                    currentM -= 60;
                    currentH += 1;
                }
            }
        });
        return slotSet;
    } catch (e) {
        console.warn(`ì‚¬ìš©ì ${nickname}ì˜ ìŠ¬ë¡¯ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:`, e.message);
        return new Set();
    }
}

document.getElementById('findIntersectBtn').onclick = async () => {
    const userNicknamesInput = document.getElementById('intersectUserNicknames').value;
    const userNicknames = userNicknamesInput.split(',').map(n => n.trim()).filter(n => n.length > 0);
    const dayOfWeek = Number(document.getElementById('slotDayOfWeek').value); 

    if (userNicknames.length < 2) {
        alert('2ëª… ì´ìƒì˜ ìœ íš¨í•œ ì‚¬ìš©ì ë‹‰ë„¤ì„ì„ ì‰¼í‘œë¡œ êµ¬ë¶„í•˜ì—¬ ì…ë ¥í•˜ì„¸ìš”.');
        return;
    }

    document.getElementById('intersectResult').innerHTML = '<div class="muted">...ë°ì´í„° ë¡œë”© ì¤‘...</div>';

    const allUserSlotSets = [];
    for (const nickname of userNicknames) {
        const slotSet = await getUserSlotsByDay(nickname, dayOfWeek);
        allUserSlotSets.push(slotSet);
    }

    let intersectionSet = allUserSlotSets[0];
    for (let i = 1; i < allUserSlotSets.length; i++) {
        intersectionSet = new Set([...intersectionSet].filter(slot => allUserSlotSets[i].has(slot)));
    }

    const sortedIntersectTimes = Array.from(intersectionSet).sort();
    
    const resultRanges = [];
    let currentRange = null;

    for (const time of sortedIntersectTimes) {
        const [h, m] = getHourMinute(time + ':00'); 
        
        if (currentRange) {
            const [lastH, lastM] = getHourMinute(currentRange.endTime + ':00');
            
            let nextH = lastH, nextM = lastM + 30;
            if (nextM >= 60) { nextM -= 60; nextH += 1; }

            if (formatTime(nextH, nextM).substring(0, 5) === time) {
                let newEndH = h, newEndM = m + 30;
                if (newEndM >= 60) { newEndM -= 60; newEndH += 1; }
                currentRange.endTime = formatTime(newEndH, newEndM).substring(0, 5);
                continue;
            } else {
                resultRanges.push(currentRange);
                currentRange = null;
            }
        }
        
        if (!currentRange) {
            let endH = h, endM = m + 30;
            if (endM >= 60) { endM -= 60; endH += 1; }
            currentRange = {
                startTime: time,
                endTime: formatTime(endH, endM).substring(0, 5)
            };
        }
    }
    if (currentRange) resultRanges.push(currentRange);

    const resultElement = document.getElementById('intersectResult');
    if (resultRanges.length === 0) {
        resultElement.innerHTML = '<div class="err" style="display:block;padding:10px;">ëª¨ë“  ì°¸ì—¬ìê°€ ê°€ëŠ¥í•œ ê³µí†µ ì‹œê°„ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
    } else {
        const dayMap = {1: 'ì›”', 2: 'í™”', 3: 'ìˆ˜', 4: 'ëª©', 5: 'ê¸ˆ', 6: 'í† ', 7: 'ì¼'};
        resultElement.innerHTML = `
            <div style="font-weight:600;">${dayMap[dayOfWeek]}ìš”ì¼ ê³µí†µ ê°€ëŠ¥ ì‹œê°„ (${userNicknames.length}ëª…)</div>
            <div class="ranges" style="margin-top:10px; display:flex; flex-wrap:wrap; gap:8px;">
                ${resultRanges.map(r => `<div class="chip">${r.startTime} ~ ${r.endTime}</div>`).join('')}
            </div>
        `;
    }
};

// --- ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸°
document.getElementById('openModalBtn').onclick = ()=>document.getElementById('timeModal').classList.add('show');
document.getElementById('closeModalBtn').onclick = ()=>document.getElementById('timeModal').classList.remove('show');

// --- ì´ˆê¸° ì‹¤í–‰
window.onload = loadSchedules;

</script>
</body>
</html>