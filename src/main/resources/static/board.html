<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>í† ë¡ /ì°¬ë°˜ ê²Œì‹œíŒ</title>
<style>
:root{
    --blue:#2563eb;
    --line:#e9edf2;
    --text:#1f2937;
    --sub:#6b7280;
    --green:#10b981;
    --red:#ef4444;
}
body {
    font-family: sans-serif;
    background:#f8fafc;
    margin:0;
    padding:24px;
}
.container { max-width:900px; margin:0 auto; }
h1 { margin-bottom:20px; }
.nav-btn {
    background: var(--blue);
    color:white;
    padding:10px 15px;
    border-radius:8px;
    text-decoration:none;
    display:inline-block;
    margin-bottom:20px;
    font-weight:600;
    border:none;
    cursor:pointer;
}
.post-card {
    background:#fff;
    padding:20px;
    border-radius:12px;
    box-shadow:0 4px 16px rgba(0,0,0,.03);
    border:1px solid var(--line);
    margin-bottom:15px;
}
.post-header {
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:10px;
}
.post-type {
    font-size:12px;
    padding:4px 8px;
    border-radius:999px;
    font-weight:700;
    color:white;
}
.debate { background: var(--red);}
.discussion { background: var(--green);}
.post-title { font-size:18px; font-weight:700; margin:0 0 8px; cursor:pointer; }
.post-content { color: var(--sub); margin-bottom:15px; }
.vote-section button {
    padding:8px 15px;
    border-radius:8px;
    cursor:pointer;
    font-weight:600;
    margin-right:10px;
    border:none;
}
.vote-for { background:#d1fae5; color:#065f46; border:1px solid #34d399; }
.vote-against { background:#fee2e2; color:#991b1b; border:1px solid #f87171; }
.vote-result { margin-top:10px; font-size:14px; }
.muted { color:var(--sub); font-size:14px; }
.comment-box { margin-top:10px; border-top:1px solid var(--line); padding-top:10px; }
.comment { background:#f3f4f6; padding:8px; border-radius:8px; margin-bottom:6px; }
.comment small { color:var(--sub); }
#createForm { background:#fff; padding:20px; border-radius:12px; margin-bottom:20px; }
#createForm input, textarea, select { width:100%; padding:10px; margin-bottom:10px; border:1px solid #ddd; border-radius:8px; }
.comment-input-row { display: flex; gap: 8px; align-items: flex-end; margin-top: 10px; }
.comment-input-row input { flex-grow: 1; height: 40px; }
.comment-input-row button { height: 40px; white-space: nowrap; }
/* ìˆ˜ì • í¼ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
#editForm {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 100;
    display: flex;
    justify-content: center;
    align-items: center;
}
#editForm .modal-content {
    background: #fff;
    max-width: 500px;
    margin: 50px auto;
    padding: 20px;
    border-radius: 12px;
}
#editPostTitle, #editPostContent {
    width: 100%;
    padding: 10px;
    margin-bottom: 10px;
    border: 1px solid #ddd;
    border-radius: 8px;
}
</style>
</head>
<body>
<div class="container">
<h1>ğŸ’¬ í† ë¡ /ì°¬ë°˜ ê²Œì‹œíŒ</h1>
<button class="nav-btn" onclick="openCreateForm()">âœï¸ ìƒˆ ê¸€ì“°ê¸°</button>

<div id="createForm" style="display:none;">
<h3>ê²Œì‹œê¸€ ì‘ì„±</h3>
<input id="postTitle" placeholder="ì œëª© ì…ë ¥">
<textarea id="postContent" placeholder="ë‚´ìš© ì…ë ¥"></textarea>
<select id="postType">
    <option value="discussion">ì¼ë°˜ í† ë¡ </option>
    <option value="debate">ì°¬ë°˜ í† ë¡ </option>
</select>
<input id="postNickname" placeholder="ë‹‰ë„¤ì„ ì…ë ¥ (DBì— ìˆëŠ” ë‹‰ë„¤ì„)">
<button class="nav-btn" style="background:var(--green)" onclick="createPost()">ë“±ë¡</button>
<button class="nav-btn" style="background:gray" onclick="closeCreateForm()">ì·¨ì†Œ</button>
</div>

<div id="editForm" style="display:none;">
    <div class="modal-content">
        <h3>ê²Œì‹œê¸€ ìˆ˜ì •</h3>
        <input type="hidden" id="editPostId">
        <input id="editPostTitle" placeholder="ì œëª© ì…ë ¥">
        <textarea id="editPostContent" placeholder="ë‚´ìš© ì…ë ¥"></textarea>
        <button class="nav-btn" style="background:var(--blue)" onclick="updatePost()">ì €ì¥</button>
        <button class="nav-btn" style="background:gray" onclick="closeEditForm()">ì·¨ì†Œ</button>
    </div>
</div>

<div id="postList"><p class="muted">ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div>
</div>

<script>
// ğŸ“Œ API ê²½ë¡œ ìƒìˆ˜í™”
const POST_API_PATH = '/api/posts'; 
const VOTE_API_PATH = '/api/posts'; 

// ğŸ“Œ Mock user ID (íˆ¬í‘œëŠ” userIdë¥¼ ìš”êµ¬í•©ë‹ˆë‹¤. DBì— ID=1ì¸ ìœ ì €ê°€ ë°˜ë“œì‹œ ì¡´ì¬í•´ì•¼ í•©ë‹ˆë‹¤.)
const MOCK_USER_ID = 1; 

// ğŸ“Œ API í†µì‹  í•¨ìˆ˜
async function api(endpoint, method='GET', body=null){
    const token = localStorage.getItem('userToken'); 
    const res = await fetch(endpoint, {
        method, 
        headers:{'Content-Type':'application/json','Authorization': token?`Bearer ${token}`:''},
        body: body?JSON.stringify(body):null
    });
    
    if(res.status === 204) return null; // ì‚­ì œ(DELETE) ì„±ê³µ ì‹œ 204
    if(res.status === 201) return null; 
    
    if(!res.ok){ 
        const contentType = res.headers.get("content-type");
        let errorText = `ì„œë²„ ì˜¤ë¥˜ (ìƒíƒœ ì½”ë“œ: ${res.status})`;
        try {
            const errorBody = contentType && contentType.includes("application/json") ? await res.json() : await res.text();
            errorText = (typeof errorBody === 'object' && errorBody.message) ? errorBody.message : (typeof errorBody === 'string' && errorBody.length > 0) ? errorBody : errorText;
        } catch (e) {
            errorText = `ì„œë²„ ì˜¤ë¥˜ (ìƒíƒœ ì½”ë“œ: ${res.status})`;
        }
        alert(errorText);
        throw new Error(errorText); 
    }
    return await res.json();
}

// í¼ ì œì–´
function openCreateForm(){ document.getElementById('createForm').style.display='block'; }
function closeCreateForm(){ document.getElementById('createForm').style.display='none'; }

// ğŸš¨ ìˆ˜ì • í¼ ì œì–´
function openEditForm(id, title, content) {
    document.getElementById('editPostId').value = id;
    document.getElementById('editPostTitle').value = title;
    document.getElementById('editPostContent').value = content;
    document.getElementById('editForm').style.display = 'flex'; // flexë¡œ ë³€ê²½
}
function closeEditForm() {
    document.getElementById('editForm').style.display = 'none';
}


// âœ… 1. ìƒˆ ê²Œì‹œê¸€ ë“±ë¡ (DB ì €ì¥)
async function createPost(){
    const title = postTitle.value.trim();
    const content = postContent.value.trim();
    const type = postType.value.toLowerCase(); 
    const nickname = postNickname.value.trim(); 
    
    if(!title || !content || !nickname){ alert('ì œëª©, ë‚´ìš©, ë‹‰ë„¤ì„ì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.'); return; }

    const postRequest = {
        title,
        content,
        type,
        nickname
    };

    try {
        await api(POST_API_PATH,'POST', postRequest);
        alert('ê²Œì‹œê¸€ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
        closeCreateForm();
        postTitle.value = '';
        postContent.value = '';
        postNickname.value = '';
        fetchPosts(); 
    } catch(e) {
        console.error('ê²Œì‹œê¸€ ë“±ë¡ ì‹¤íŒ¨:', e);
    }
}

// âœ… 2. ê²Œì‹œê¸€ ë¶ˆëŸ¬ì˜¤ê¸° (DB ì¡°íšŒ)
async function fetchPosts(){
    try {
        const posts = await api(POST_API_PATH,'GET');
        renderPosts(posts || []);
    } catch(e) {
        document.getElementById('postList').innerHTML = '<p class="muted">ê²Œì‹œê¸€ ë¶ˆëŸ¬ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
        console.error('ê²Œì‹œê¸€ ì¡°íšŒ ì‹¤íŒ¨:', e);
    }
}

// âœ… 3. ê²Œì‹œê¸€ ì¶œë ¥ ë° íˆ¬í‘œ ë²„íŠ¼ ì—°ê²° (ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ ì¶”ê°€)
function renderPosts(posts){
    const list=document.getElementById('postList'); 
    list.innerHTML='';
    if(posts.length===0){ list.innerHTML='<p class="muted">ë“±ë¡ëœ ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>'; return; }
    
    posts.forEach(p=>{
        const isDebate = p.postType === 'debate'; 
        
        const votesFor = p.votesFor || 0; 
        const votesAgainst = p.votesAgainst || 0;
        const total = votesFor + votesAgainst;
        const percent = total>0?(votesFor/total*100).toFixed(1):0;
        
        const div=document.createElement('div');
        div.className='post-card';
        div.innerHTML=`
            <div class="post-header">
                <span class="post-type ${isDebate?'debate':'discussion'}">${isDebate?'ì°¬ë°˜ í† ë¡ ':'ì¼ë°˜ í† ë¡ '}</span>
                <span class="muted">${p.author || 'ìµëª…'} | ${p.createdAt?new Date(p.createdAt).toLocaleDateString():'N/A'}</span>
            </div>
            <h3 class="post-title" onclick="toggleComments(${p.id})">${p.title}</h3>
            <p class="post-content">${p.content || 'ë‚´ìš© ì—†ìŒ'}</p>
            
            <div class="action-buttons" style="margin-top:10px;">
                <button class="nav-btn" style="background:gray; padding:5px 10px; font-size:12px;" onclick="openEditForm(${p.id}, '${p.title.replace(/'/g, "\\'")}', '${p.content.replace(/'/g, "\\'")}')">ìˆ˜ì •</button>
                <button class="nav-btn" style="background:var(--red); padding:5px 10px; font-size:12px;" onclick="deletePost(${p.id})">ì‚­ì œ</button>
            </div>
            
            ${isDebate?`
            <div class="vote-section">
                <button class="vote-for" onclick="handleVote(${p.id},'ì°¬ì„±')">ì°¬ì„± (${votesFor})</button>
                <button class="vote-against" onclick="handleVote(${p.id},'ë°˜ëŒ€')">ë°˜ëŒ€ (${votesAgainst})</button>
                <div class="vote-result">ì´ íˆ¬í‘œìˆ˜: ${total} | ì°¬ì„± ${percent}%</div>
            </div>`:``}
            <div id="comments-${p.id}" class="comment-box" style="display:none;">
                <div id="commentList-${p.id}"><p class="muted">ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div>
                <div class="comment-input-row">
                    <input id="commentNickname-${p.id}" placeholder="ë‹‰ë„¤ì„ ì…ë ¥ (DBì— ìˆëŠ” ë‹‰ë„¤ì„)" style="width:150px; flex-grow:0;">
                    <textarea id="commentInput-${p.id}" placeholder="ëŒ“ê¸€ ì‘ì„±..." style="flex-grow:1;"></textarea>
                    <button class="nav-btn" style="background:var(--blue);" onclick="addComment(${p.id})">ë“±ë¡</button>
                </div>
            </div>`;
        list.appendChild(div);
    });
}

// âœ… 4. ì‹¤ì œ íˆ¬í‘œ ì²˜ë¦¬ (API í˜¸ì¶œ)
async function handleVote(postId, voteType){
    
    const voteRequest = {
        userId: MOCK_USER_ID,
        voteType: voteType 
    };

    try {
        await api(`${VOTE_API_PATH}/${postId}/vote`, 'POST', voteRequest); 
        alert(`íˆ¬í‘œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. (${voteType})`);
        fetchPosts(); 
    } catch(e) {
        console.error('íˆ¬í‘œ ì‹¤íŒ¨:', e);
    }
}

// âœ… 5. ëŒ“ê¸€ ë³´ê¸°/ìˆ¨ê¸°ê¸° ë° ë¶ˆëŸ¬ì˜¤ê¸° (API í˜¸ì¶œ)
async function toggleComments(postId){
    const commentBox = document.getElementById(`comments-${postId}`);
    const commentList = document.getElementById(`commentList-${postId}`);

    if (commentBox.style.display === 'none') {
        commentBox.style.display = 'block';
        commentList.innerHTML = '<p class="muted">ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';
        
        try {
            const comments = await api(`${POST_API_PATH}/${postId}/comments`, 'GET'); 
            renderComments(postId, comments);
        } catch(e) {
            commentList.innerHTML = '<p class="muted">ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
            console.error('ëŒ“ê¸€ ì¡°íšŒ ì‹¤íŒ¨:', e);
        }
    } else {
        commentBox.style.display = 'none';
    }
}

// âœ… 6. ëŒ“ê¸€ ì¶œë ¥ (DTO í•„ë“œì— ë§ê²Œ ìˆ˜ì •)
function renderComments(postId, comments){
    const commentList = document.getElementById(`commentList-${postId}`);
    commentList.innerHTML = '';
    if(comments.length === 0) {
        commentList.innerHTML = '<p class="muted">ë“±ë¡ëœ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
    }
    
    comments.forEach(c => {
        const commentDiv = document.createElement('div');
        commentDiv.className = 'comment';
        const authorNickname = c.authorNickname || 'ìµëª…';

        commentDiv.innerHTML = `
            <strong>${authorNickname}</strong>: ${c.content}
            <small>(${new Date(c.createdAt).toLocaleString()})</small>
        `;
        commentList.appendChild(commentDiv);
    });
}

// âœ… 7. ëŒ“ê¸€ ë“±ë¡ (API í˜¸ì¶œ)
async function addComment(postId){
    const nickname = document.getElementById(`commentNickname-${postId}`).value.trim();
    const content = document.getElementById(`commentInput-${postId}`).value.trim();
    
    if(!nickname || !content){ alert('ë‹‰ë„¤ì„ê³¼ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.'); return; }

    const commentRequest = {
        nickname: nickname,
        content: content
    };

    try {
        await api(`${POST_API_PATH}/${postId}/comments`, 'POST', commentRequest);
        alert('ëŒ“ê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
        document.getElementById(`commentInput-${postId}`).value = '';
        document.getElementById(`commentNickname-${postId}`).value = '';
        // ëŒ“ê¸€ ëª©ë¡ì„ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸° ìœ„í•´ ë‘ ë²ˆ í˜¸ì¶œ
        toggleComments(postId); 
        toggleComments(postId); 
    } catch(e) {
        console.error('ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨:', e);
    }
}

// âœ… 8. ê²Œì‹œê¸€ ìˆ˜ì • (PUT API í˜¸ì¶œ)
async function updatePost() {
    const id = document.getElementById('editPostId').value;
    const title = document.getElementById('editPostTitle').value.trim();
    const content = document.getElementById('editPostContent').value.trim();

    if (!title || !content) { alert('ì œëª©ê³¼ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.'); return; }

    const updateRequest = {
        title,
        content,
        // ë‹‰ë„¤ì„ í•„ë“œë¥¼ ì¶”ê°€í•˜ë©´ ìˆ˜ì • ê¶Œí•œ ì²´í¬ ê°€ëŠ¥
        // nickname: 'ì‘ì„±ì ë‹‰ë„¤ì„' 
    };

    try {
        await api(`${POST_API_PATH}/${id}`, 'PUT', updateRequest);
        alert('ê²Œì‹œê¸€ì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
        closeEditForm();
        fetchPosts(); 
    } catch(e) {
        console.error('ê²Œì‹œê¸€ ìˆ˜ì • ì‹¤íŒ¨:', e);
    }
}

// âœ… 9. ê²Œì‹œê¸€ ì‚­ì œ (DELETE API í˜¸ì¶œ)
async function deletePost(id) {
    if (!confirm('ì •ë§ë¡œ ì´ ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { return; }

    try {
        // DELETEëŠ” ë³´í†µ ë³¸ë¬¸ì´ ì—†ê³  ì‘ë‹µë„ 204 No Content
        await api(`${POST_API_PATH}/${id}`, 'DELETE'); 
        alert('ê²Œì‹œê¸€ì´ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        fetchPosts(); 
    } catch(e) {
        console.error('ê²Œì‹œê¸€ ì‚­ì œ ì‹¤íŒ¨:', e);
    }
}

// ì´ˆê¸° ì‹¤í–‰
fetchPosts();
</script>
</body>
</html>